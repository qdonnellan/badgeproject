{% extends 'user_base.html' %}

{% block body %}

<div>
  <div class="row">
    <h1>{{course.course_name}}</h1>
    {% if teacher_view_student_profile %}
      <div class="callout callout-danger">
        <a href="/course/{{course.key.id()}}" class="btn btn-default pull-right btn-small">Back to Teacher View</a>
        <h4><span class="text-muted">Student:</span> {{student.formalName}}</h4>
        <p>You are currently viewing this student's course profile. This page will appear to you as it does to the student. Clicking on badges will take you to the student's view of those badges. If you would like to go back to the teacher view of this page, just click <a href="/course/{{course.key.id()}}">back to teacher view</a></p>
      </div>
    {% endif %}
    {% if student_profile %}
      <p class="text-muted">Instructor: {{course.key.parent().get().formalName}}</p>
    {% endif %}
    
  </div>

  <div class="row">
    <ul class="nav nav-tabs">
      <li {% if active_tab == 'checkpoints' or not active_tab%}class="active"{% endif %}><a href="#checkpoints" data-toggle="tab">Checkpoints</a></li>
      {% if student_profile or teacher_view_student_profile %}
        <li {% if active_tab == 'requests' %}class="active"{% endif %}><a href="#requests" data-toggle="tab">Pending Requests</a></li>
      {% else %}
        <li {% if active_tab == 'requests' %}class="active"{% endif %}>
          <a href="#requests" data-toggle="tab">
            {% set requests = get_number_of_badge_requests(course) %}
            {% if requests > 0 %}
              <span class="badge badge-notification">{{requests}} </span>
            {% endif %}
            Badge Requests
          </a>
        </li>
      {% endif %}
      {% if user_is_teacher(course, local_user) and not (student_profile or teacher_view_student_profile)%}
        <li {% if active_tab == 'students' %}class = "active"{% endif %}>
          <a href="#students" data-toggle="tab">
            {% set pending_regs = get_number_of_pending_registrations(course) %}
            {% if pending_regs > 0 %}
              <span class="badge badge-notification">{{pending_regs}} </span>
            {% endif %}
            Enrolled Students
            
          </a>
        </li>
        <li {% if active_tab == 'settings' %}class = "active"{% endif %}><a href="#settings" data-toggle="tab">Settings</a></li>

      {% endif %}  
      
      
    </ul>

    <div class="tab-content">
      {% if user_is_teacher(course, local_user) and not (student_profile or teacher_view_student_profile) %}
      <div class="tab-pane fade {% if active_tab == 'students' %}in active{% endif %}" id="students">
        {% if registrations %}
          <div>
            <h3>Students Enrolled in Course</h3>
            <p class='text-muted'>Click on a student's name to view that student's progress in this course</p>
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Student Name</th>
                  <th>Registration Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for registration in registrations %}
                <tr>
                  <td>
                    <a href="/student_profile/{{registration.student_id}}/{{course.key.id()}}/teacher_view">
                      {{get_student(registration.student_id).formalName}}
                    </a>
                  </td>
                  <td>
                    {% set reg_status = registration.status %}
                    {% if reg_status == 'approved' %}
                      <span class="text-success">enrolled</span>
                    {% elif reg_status == 'revoked' %}
                      <span class="text-danger">enrollment revoked</span>
                    {% else %}
                      <span class="text-muted">not enrolled</span>
                    {% endif %}
                    
                  </td>
                  <td>
                  {% if registration.status == "pending"%}
                    <a class="btn btn-small btn-success" href="/complete_registration/{{course.key.id()}}/{{registration.student_id}}/approved">approve</a> 
                    <a class="btn btn-small btn-danger" href="/complete_registration/{{course.key.id()}}/{{registration.student_id}}/denied}}">deny</a>
                  {% elif registration.status == "approved" %}
                    <a class="btn btn-small btn-warning" href="/complete_registration/{{course.key.id()}}/{{registration.student_id}}/revoked">un-enroll</a>
                  {% elif registration.status == "denied" %}
                    <a class="btn btn-small btn-success" href="/complete_registration/{{course.key.id()}}/{{registration.studen_id}}/approved">approve</a> 
                  {% elif registration.status == "revoked" %}
                    <a class="btn btn-small btn-info" href="/complete_registration/{{course.key.id()}}/{{registration.student_id}}/approved">re-admit</a>

                  {% endif %}  
                  </td>         

                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

      </div>
      {% endif %}

      <div class="tab-pane fade {% if active_tab == 'checkpoints' or not active_tab %}in active{% endif %}" id="checkpoints">
        <br>
        {% if user_is_teacher(course, local_user) and not (student_profile or teacher_view_student_profile) %}
        <div>
          <a class="btn btn-primary" href="/course/{{course.key.id()}}/new_checkpoint">New Checkpoint</a>
        </div>
        {% endif %}
        <br>
          {% include 'checkpoint_list.html' %}
      </div>
      {% if student_profile or teacher_view_student_profile %}
      <div class="tab-pane fade {% if active_tab == 'requests' %}in active{% endif %}" id="requests">
        <br>
        {% set requests = get_badge_requests(course, indiv_student = student, denied_on = True) %}
        {% if requests %}
          <table class="table">
            <thead>
              <tr>
                <th>Badge</th>
                <th>Request Status</th>
                <th>Last Update</th>
              </tr>
            </thead>
            <tbody>
              {% for request in requests %}
              <tr>
                <td>
                  {% if teacher_view_student_profile %}
                  <a href="/student_badge/{{student.key.id()}}/{{course.key.id()}}/{{request.badge_id}}/teacher_view">
                  {% else %}
                  <a href="/student_badge/{{teacherID}}/{{course.key.id()}}/{{request.badge_id}}">
                  {% endif %}
                    {% set badge = get_badge(teacher, request.badge_id) %}
                    <div class="tiny-badge pull-left">
                      <div  class="badge-new" style="background: {{badge.background}}; color: {{badge.icon_color}}">
                        <div class="badge-icon-container"><i class="icon-{{badge.icon}}"></i></div>
                      </div>
                    </div> {{badge.name}}
                  </a>  
                </td>
                <td>{{request.status}}</td>
                <td>...</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <h3 class='text-muted'>No active badge requests</h3>
        {% endif %}
      </div>
      {% else %}
      <div class="tab-pane fade {% if active_tab == 'requests' %}in active{% endif %}" id="requests">
        <br>
        {% set requests = get_badge_requests(course) %}
        {% if requests %}
          <table class="table">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Badge</th>
                <th>Request Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for request in requests %}
                {% set student = get_student(request.key.parent().get().key.id()) %}
                <tr>
                  <td>{{student.formalName}}</td>
                  <td>
                    <a href="/student_badge/{{student.key.id()}}/{{course.key.id()}}/{{request.badge_id}}/teacher_view">
                      {% set badge = get_badge(local_user, request.badge_id) %}
                      <div class="tiny-badge pull-left">
                        <div  class="badge-new" style="background: {{badge.background}}; color: {{badge.icon_color}}">
                          <div class="badge-icon-container"><i class="icon-{{badge.icon}}"></i></div>
                        </div>
                      </div> {{badge.name}}
                    </a>
                  </td>
                  <td>{{request.status}}</td>
                  <td>
                    <a class="btn btn-info btn-small" href="/student_badge/{{student.key.id()}}/{{course.key.id()}}/{{request.badge_id}}/teacher_view">View Evidence</a> 
                    <a class="btn btn-danger btn-small" href="/student_badge/{{student.key.id()}}/{{course.key.id()}}/{{request.badge_id}}/teacher_view/award/denied">Deny</a> 
                    <a class="btn btn-success btn-small" href="/student_badge/{{student.key.id()}}/{{course.key.id()}}/{{request.badge_id}}/teacher_view/award/awarded">Award Badge</a>

                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <h3 class='text-muted'>No active badge requests</h3>
        {% endif %}
      </div>
      {% endif %}
      <div class="tab-pane fade {% if active_tab == 'settings' %}in active{% endif %}" id="settings">
        
        <div class="row">
          <div>
            <form method="post" class="col-lg-6">   
              <h3>Course Name</h3>
                <p class="text-muted">Change your course name</p>
                <input type="text" id="course_name" class="form-control" name="course_name" value="{{course.course_name}}"/>
              <h3>Course Code</h3>
              <p class="text-muted">Your students will need your google email address and this code to register for your course</p>
                <input type="text" id="course_code" class = "form-control" name="course_code" value="{{course.course_code}}"/>
              <br>
              <button class="btn btn-primary" type="submit">Save Course</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  
</div>  

{% endblock %}